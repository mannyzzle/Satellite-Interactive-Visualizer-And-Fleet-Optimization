name: Satellite Tasks Scheduler

on:
  schedule:
    - cron: '15 */6 * * *'  # Runs every 6 hours at minute 15
    - cron: '45 */8 * * *'  # Runs every 8 hours at minute 45
    - cron: '0 * * * *'  # Runs every hour at minute 0
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PORT: 5432
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME }}
  SPACETRACK_USER: ${{ secrets.SPACETRACK_USER }}
  SPACETRACK_PASS: ${{ secrets.SPACETRACK_PASS }}

jobs:
  tle_processor:
    runs-on: ubuntu-latest
    if: github.event.schedule == '15 */6 * * *'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run TLE Processor
        run: |
          set -e
          LOG_FILE="backend/app/logs/tle_log.txt"
          echo "$(date '+[%Y-%m-%d %H:%M:%S]') Running tle_processor" >> "$LOG_FILE"
          python3 backend/app/tle_processor.py >> "$LOG_FILE" 2>&1

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: tle_logs
          path: backend/app/logs/tle_log.txt

  cdm:
    runs-on: ubuntu-latest
    if: github.event.schedule == '45 */8 * * *'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run CDM
        run: |
          set -e
          LOG_FILE="backend/app/logs/cdm_log.txt"
          echo "$(date '+[%Y-%m-%d %H:%M:%S]') Running cdm" >> "$LOG_FILE"
          python3 backend/app/cdm.py >> "$LOG_FILE" 2>&1

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: cdm_logs
          path: backend/app/logs/cdm_log.txt

  fetch_all:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run Fetch All
        run: |
          set -e
          LOG_FILE="backend/app/logs/fetch_all_log.txt"
          echo "$(date '+[%Y-%m-%d %H:%M:%S]') Running fetch_all" >> "$LOG_FILE"
          python3 backend/app/omni_low.py fetch_all >> "$LOG_FILE" 2>&1

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: fetch_all_logs
          path: backend/app/logs/fetch_all_log.txt
